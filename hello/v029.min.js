var hello={settings:{redirect_uri:msos.config.hellojs_redirect,response_type:"token",display:"popup",state:"",default_service:null,force:!0},utils:{ut_name:"hello.utils",xhr_request:function(){"use strict";var e=new XMLHttpRequest;return void 0!==e.withCredentials?e:void 0!==XDomainRequest?e=new XDomainRequest:null},xhr:function(e,s,o){"use strict";var t=this,n=t.xhr_request()||null,r="";return msos.console.debug(this.ut_name+".xhr -> start."),null!==n?(n.onload=function(){var e={};try{e=JSON.parse(n.responseText)}catch(s){e={error:{code:"parse_error",message:s.message}},msos.console.error(t.ut_name+".xhr - onload -> parse failed: "+s.message)}401===n.status&&(e={error:{code:"access_denied",message:n.statusText}},msos.console.warn(t.ut_name+".xhr - onload -> access_denied: "+n.statusText)),o(e||{error:{code:"server_error",message:n.status}})},n.onerror=function(){var e=n.responseText;try{e=JSON.parse(n.responseText)}catch(s){e={error:{code:"parse_error",message:s.message}},msos.console.error(t.ut_name+".xhr - onerror -> parse failed: "+s.message)}o(e||{error:{code:"server_error",message:n.status}})},r=t.add_qs(s,e),n.open("GET",r,!0),n.send()):msos.console.debug(this.ut_name+".xhr -> failed, na."),msos.console.debug(this.ut_name+".xhr -> done!"),n},add_qs:function(e,s){"use strict";var o,t,n;if(msos.config.verbose&&msos.console.debug(this.ut_name+".add_qs -> start, url: "+e+", params:",s),s&&!_.isEmpty(s)){for(o in s)e.indexOf(o)>-1&&(t="[\\?\\&]"+o+"=[^\\&]*",n=new RegExp(t),e=e.replace(n,""));e+=(e.indexOf("?")>-1?"&":"?")+this.param(s)}return msos.config.verbose&&msos.console.debug(this.ut_name+".add_qs -> done, url: "+e),e},param:function(e){"use strict";var s,o,t,n,r={},i=[],l=0,a="";if(msos.config.verbose&&msos.console.debug(this.ut_name+".param -> start."),"string"==typeof e){if(o=e.replace(/^[\#\?]/,"").match(/([^=\/\&]+)=([^\&]+)/g))for(l=0;l<o.length;l+=1)s=o[l].split("="),r[s[0]]=decodeURIComponent(s[1]);return msos.config.verbose&&msos.console.debug(this.ut_name+".param -> done, object:",r),r}if(t=e,_.isObject(t)){for(n in t)t.hasOwnProperty(n)&&i.push([n,"?"===t[n]?"?":encodeURIComponent(t[n])].join("="));a=i.join("&")}return msos.config.verbose&&msos.console.debug(this.ut_name+".param -> done, string: "+a),a},store:function(e,s){"use strict";var o=JSON.parse(localStorage.getItem("hello"))||{};if(e&&void 0===s)return o[e];if(e&&""===s)try{delete o[e]}catch(t){o[e]=null}else{if(!e)return o;o[e]=s}return localStorage.setItem("hello",JSON.stringify(o)),o},append:function(e,s,o){"use strict";var t,n,r="string"==typeof e?document.createElement(e):e,i="";if(msos.console.debug(this.ut_name+".append -> start."),"object"==typeof s)if(s.tagName)o=s;else for(t in s)if(s.hasOwnProperty(t))if("object"==typeof s[t])for(n in s[t])s[t].hasOwnProperty(n)&&(r[t][n]=s[t][n]);else"html"===t?r.innerHTML=s[t]:/^on/.test(t)?r[t]=s[t]:r.setAttribute(t,s[t]);return"body"===o?(i="body",function l(){document.body?document.body.appendChild(r):setTimeout(l,16)}()):"object"==typeof o?(i="dom object",o.appendChild(r)):"string"==typeof o?(i=o,document.getElementsByTagName(o)[0].appendChild(r)):i="no target",msos.console.debug(this.ut_name+".append -> done, target: "+i),r},merge:function(e,s){"use strict";var o,t={};if("object"==typeof e&&"object"==typeof s){for(o in e)t[o]=e[o],void 0!==s[o]&&(t[o]=this.merge(e[o],s[o]));for(o in s)void 0===e[o]&&(t[o]=s[o])}else t=s;return t},Event:function(){"use strict";this.parent={events:this.events,findEvents:this.findEvents,parent:this.parent,utils:this.utils},this.events={},this.on=function(e,s){if(s&&"function"==typeof s){var o=e.split(/[\s\,]+/),t=0;for(t=0;t<o.length;t+=1)this.events[o[t]]=[s].concat(this.events[o[t]]||[])}return this},this.off=function(e,s){return this.findEvents(e,function(e,o){s&&this.events[e][o]!==s||this.events[e].splice(o,1)}),this},this.emit=function(e){var s=Array.prototype.slice.call(arguments,1),o=this;for(s.push(e);o&&o.findEvents;)o.findEvents(e,function(e,o){s[s.length-1]=e,this.events[e][o].apply(this,s)}),o=o.parent;return this},this.emitAfter=function(){var e=this,s=arguments;return setTimeout(function(){e.emit.apply(e,s)},10),this},this.success=function(e){return this.on("success",e)},this.error=function(e){return this.on("error",e)},this.failed=function(e){return this.on("failed",e)},this.findEvents=function(e,s){var o,t=e.split(/[\s\,]+/),n=0;for(o in this.events)if(this.events.hasOwnProperty(o)&&_.indexOf(t,o)>-1)for(n=0;n<this.events[o].length;n+=1)s.call(this,o,n)}},globalEvent:function(e,s){"use strict";return s=s||"hellojs_"+parseInt(1e12*Math.random(),10).toString(36),msos.console.debug(this.ut_name+".globalEvent -> start, guid: "+s),window[s]=function(){var o=e.apply(this,arguments);if(msos.console.debug(s+" ~~~> start."),o)try{delete window[s],msos.console.debug(s+" ~~~> delete: "+s)}catch(t){msos.console.error(s+" ~~~> delete failed, reason: "+t.message)}msos.console.debug(s+" ~~~> done!")},msos.console.debug(this.ut_name+".globalEvent -> done, guid: "+s),s},hasBinary:function(e){var s;for(s in e)if(e.hasOwnProperty(s)&&this.isBinary(e[s]))return!0;return!1},isBinary:function(e){return e instanceof Object&&(this.domInstance("input",e)&&"file"===e.type||"FileList"in window&&e instanceof window.FileList||"File"in window&&e instanceof window.File||"Blob"in window&&e instanceof window.Blob)},toBlob:function(e){var s,o=/^data\:([^;,]+(\;charset=[^;,]+)?)(\;base64)?,/i,t=e.match(o),n=[],r=0;if(!t)return e;for(s=atob(e.replace(o,"")),r=0;r<s.length;r+=1)n.push(s.charCodeAt(r));return new Blob([new Uint8Array(n)],{type:t[1]})}},service:function(e){"use strict";return msos.console.debug("hello.service -> called."),void 0!==e?this.utils.store("sync_service",e):this.utils.store("sync_service")},services:{},using:function(e){"use strict";msos.console.debug("hello.using -> start.");var s=Object.create(this);return s.settings=Object.create(this.settings),e&&(s.settings.default_service=e),s.utils.Event.call(s),msos.console.debug("hello.using -> done!"),s},init:function(e,s){"use strict";msos.config.verbose?msos.console.debug("hello.init -> start, service:",e):msos.console.debug("hello.init -> start."),e?(this.services=_.extend(this.services,e),s&&(this.settings=_.extend(this.settings,s))):msos.console.warn("hello.init -> no service input."),msos.console.debug("hello.init -> done!")},login:function(e){"use strict";var s,o,t,n,r,i,l,a,c,u,d=this.using(),h=d.utils,p=!1,g=msos.config.size_wide[msos.config.size];return msos.config.verbose?msos.console.debug("hello.login -> start, p:",e):msos.console.debug("hello.login -> start."),e=_.isObject(e)?e:{},e.options=_.isObject(e.options)?e.options:{},e.options=h.merge(d.settings,e.options),e.network=d.settings.default_service=e.network||d.settings.default_service,d.services[e.network]?(o=d.services[e.network],t=h.globalEvent(function(e){msos.config.verbose&&msos.console.debug("hello.login - cb -> start, obj: ",e),p=!0,e.error?(msos.console.error("hello.login - cb -> error:",e.error),d.emit("failed",{error:e.error})):(h.store(e.network,e),d.emit("auth.success",{network:e.network,authResponse:e})),msos.config.verbose&&msos.console.debug("hello.login - cb -> done!")}),e.qs={client_id:o.id,response_type:e.options.response_type,redirect_uri:e.options.redirect_uri,display:e.options.display,scope:"basic",state:{client_id:o.id,network:e.network,display:e.options.display,callback:t,state:e.options.state}},n=h.store(e.network),i=e.options.scope,i&&"string"!=typeof i&&(i=i.join(",")),i=(i?i+",":"")+e.qs.scope,n&&n.scope&&(i+=","+n.scope.join(",")),e.qs.state.scope=_.uniq(i.split(/[,\s]+/)),e.qs.scope=i.replace(/[^,\s]+/gi,function(e){return o.scope[e]||""}).replace(/[,\s]+/gi,","),e.qs.scope=_.uniq(e.qs.scope.split(/,+/)).join(o.scope_delim||","),e.options.force===!1&&n&&n.access_token&&n.expires&&n.expires>(new Date).getTime()/1e3&&(r=_.difference(n.scope||[],e.qs.state.scope||[]),0===r.length)?(msos.console.debug("hello.login -> found user access_token."),d.emitAfter("auth.success",{network:e.network,authResponse:n}),d):(o.oauth&&(e.qs.state.oauth=o.oauth),e.qs.state=JSON.stringify(e.qs.state),o.login&&"function"==typeof o.login&&o.login(e),s=h.add_qs(o.oauth.auth,e.qs),msos.console.debug("hello.login -> display: "+e.options.display||"undefined"),"none"===e.options.display?h.append("iframe",{src:s,style:{position:"absolute",left:"-1000px",bottom:0,height:"1px",width:"1px"}},"body"):"popup"===e.options.display?(l=e.options.window_height||520,a=e.options.window_width||(520>g?g:520),c=window.open(s,t+"_window","resizeable=true,height="+l+",width="+a+",left="+(window.innerWidth-a)/2+",top="+(window.innerHeight-l)/2),c.focus(),u=setInterval(function(){c.closed&&(clearInterval(u),p||d.emit("failed",{error:{code:"login_cancelled",message:e.network}}))},100)):window.location=s,msos.console.debug("hello.login -> done!"),d)):(d.emitAfter("error",{error:{code:"invalid_network",message:e.network}}),msos.console.warn("hello.login -> done, network na."),d)},logout:function(e){"use strict";var s,o=this.using();if(e=_.isObject(e)?e:{},msos.config.verbose?msos.console.debug("hello.logout -> start, p:",e):msos.console.debug("hello.logout -> start."),e.network=e.network||o.settings.default_service,!o.services[e.network])return o.emitAfter("error",{error:{code:"invalid_network",message:e.network}}),msos.console.error("hello.logout -> done, invalid network."),o;if(o.utils.store(e.network))"function"==typeof o.services[e.network].logout&&o.services[e.network].logout(e),o.utils.store(e.network,""),msos.config.verbose&&msos.console.debug("hello.logout -> logged out:"+e.network);else{if("all"!==e.network)return o.emitAfter("error",{error:{code:"invalid_session",message:e.network}}),msos.console.error("hello.logout -> missing a session for: "+e.network),o;msos.config.verbose&&msos.console.debug("hello.logout -> logging out of all services.");for(s in o.services)o.services.hasOwnProperty(s)&&o.logout(s);o.service(!1)}return o.emitAfter("logout.success",!0),msos.console.debug("hello.logout -> done!"),o},getAuthResponse:function(e){"use strict";return msos.console.debug("hello.getAuthResponse -> start."),e=e||this.settings.default_service,e&&this.services[e]?(msos.console.debug("hello.getAuthResponse -> done!"),this.utils.store(e)||null):(this.emit("error",{error:{code:"invalid_network",message:e||"na"}}),msos.console.error("hello.getAuthResponse -> done, invalid network."),null)},events:{}};hello.utils.Event.call(hello),hello.api=function(e){"use strict";function s(s){var i,l,a,c,u=/[\?\&]([^=&]+)(=([^&]+))?/gi,d=n.getAuthResponse(e.network),h=d?d.access_token:null,p={access_token:h||""};for(msos.console.debug("hello.api - processPath -> start, path: "+s);i=u.exec(s);)e.data[i[1]]=i[3];s=s.replace(/\?.*/,""),l=t.get[s]||s,l=l.replace(/\@\{([a-z\_\-]+)(\|.+?)?\}/gi,function(s,o,t){var r=t?t.replace(/^\|/,""):"";return e.data[o]?(r=e.data[o],delete e.data[o]):n.emitAfter("error",{error:{code:"invalid_attribute",message:o}}),r}),a=t.base+l,_.isEmpty(e.data)||(p=r.merge(p,e.data)),t.querystring&&t.querystring(p),t.jsonp?(msos.console.debug("hello.api - processPath -> jsonp"),t.jsonp(p,a,o)):(msos.console.debug("hello.api - processPath -> XMLHttpRequest"),c=r.xhr(p,a,o),null===c&&(n.emitAfter("error",{error:{code:"browser_warning",message:navigator.userAgent}}),msos.console.warn("hello.api - processPath -> browser too old."))),msos.console.debug("hello.api - processPath -> done!")}msos.console.debug("hello.api -> start.");var o,t,n=this.using(),r=n.utils;return e.path=(e.path||"me").toLowerCase(),e.network=e.network||n.settings.default_service||"na",(t=n.services[e.network]||void 0)?(n.settings.default_service=e.network,msos.config.verbose&&msos.console.debug("hello.api -> network object:",t),o=function(e){msos.console.debug("hello.api - api_cb -> start."),t.error&&t.error(e),n.emit("complete "+(!e||e.error?"error":"success"),e),msos.console.debug("hello.api - api_cb -> done!")},t.get[e.path]?(s(e.path),msos.console.debug("hello.api -> done!"),n):(msos.console.error("hello.api -> path: "+e.path+" na in: "+e.network),n.emitAfter("error",{error:{code:"invalid_path",message:e.path}}))):(n.emitAfter("error",{error:{code:"invalid_network",message:e.network}}),msos.console.error("hello.api -> network na."),n)};