!function(e){"use strict";var t,s=e.Base64,n="2.1.9";if("undefined"!=typeof module&&module.exports)try{t=require("buffer").Buffer}catch(i){}var r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",o=function(e){for(var t={},s=0,n=e.length;n>s;s++)t[e.charAt(s)]=s;return t}(r),a=String.fromCharCode,h=function(e){if(e.length<2){var t=e.charCodeAt(0);return 128>t?e:2048>t?a(192|t>>>6)+a(128|63&t):a(224|t>>>12&15)+a(128|t>>>6&63)+a(128|63&t)}var t=65536+1024*(e.charCodeAt(0)-55296)+(e.charCodeAt(1)-56320);return a(240|t>>>18&7)+a(128|t>>>12&63)+a(128|t>>>6&63)+a(128|63&t)},c=/[\uD800-\uDBFF][\uDC00-\uDFFFF]|[^\x00-\x7F]/g,u=function(e){return e.replace(c,h)},d=function(e){var t=[0,2,1][e.length%3],s=e.charCodeAt(0)<<16|(e.length>1?e.charCodeAt(1):0)<<8|(e.length>2?e.charCodeAt(2):0),n=[r.charAt(s>>>18),r.charAt(s>>>12&63),t>=2?"=":r.charAt(s>>>6&63),t>=1?"=":r.charAt(63&s)];return n.join("")},l=e.btoa?function(t){return e.btoa(t)}:function(e){return e.replace(/[\s\S]{1,3}/g,d)},_=t?function(e){return(e.constructor===t.constructor?e:new t(e)).toString("base64")}:function(e){return l(u(e))},p=function(e,t){return t?_(String(e)).replace(/[+\/]/g,function(e){return"+"==e?"-":"_"}).replace(/=/g,""):_(String(e))},m=function(e){return p(e,!0)},f=new RegExp(["[À-ß][-¿]","[à-ï][-¿]{2}","[ð-÷][-¿]{3}"].join("|"),"g"),g=function(e){switch(e.length){case 4:var t=(7&e.charCodeAt(0))<<18|(63&e.charCodeAt(1))<<12|(63&e.charCodeAt(2))<<6|63&e.charCodeAt(3),s=t-65536;return a((s>>>10)+55296)+a((1023&s)+56320);case 3:return a((15&e.charCodeAt(0))<<12|(63&e.charCodeAt(1))<<6|63&e.charCodeAt(2));default:return a((31&e.charCodeAt(0))<<6|63&e.charCodeAt(1))}},b=function(e){return e.replace(f,g)},S=function(e){var t=e.length,s=t%4,n=(t>0?o[e.charAt(0)]<<18:0)|(t>1?o[e.charAt(1)]<<12:0)|(t>2?o[e.charAt(2)]<<6:0)|(t>3?o[e.charAt(3)]:0),i=[a(n>>>16),a(n>>>8&255),a(255&n)];return i.length-=[0,0,2,1][s],i.join("")},y=e.atob?function(t){return e.atob(t)}:function(e){return e.replace(/[\s\S]{1,4}/g,S)},v=t?function(e){return(e.constructor===t.constructor?e:new t(e,"base64")).toString()}:function(e){return b(y(e))},N=function(e){return v(String(e).replace(/[-_]/g,function(e){return"-"==e?"+":"/"}).replace(/[^A-Za-z0-9\+\/]/g,""))},T=function(){var t=e.Base64;return e.Base64=s,t};if(e.Base64={VERSION:n,atob:y,btoa:l,fromBase64:N,toBase64:p,utob:u,encode:p,encodeURI:m,btou:b,decode:N,noConflict:T},"function"==typeof Object.defineProperty){var x=function(e){return{value:e,enumerable:!1,writable:!0,configurable:!0}};e.Base64.extendString=function(){Object.defineProperty(String.prototype,"fromBase64",x(function(){return N(this)})),Object.defineProperty(String.prototype,"toBase64",x(function(e){return p(this,e)})),Object.defineProperty(String.prototype,"toBase64URI",x(function(){return p(this,!0)}))}}e.Meteor&&(Base64=e.Base64)}(this),function(e){if("object"==typeof exports)module.exports=e();else if("function"==typeof define&&define.amd)define(e);else{var t;try{t=window}catch(s){t=self}t.SparkMD5=e()}}(function(e){"use strict";function t(e,t,s,n,i,r){return t=b(b(t,e),b(n,r)),b(t<<i|t>>>32-i,s)}function s(e,s,n,i,r,o,a){return t(s&n|~s&i,e,s,r,o,a)}function n(e,s,n,i,r,o,a){return t(s&i|n&~i,e,s,r,o,a)}function i(e,s,n,i,r,o,a){return t(s^n^i,e,s,r,o,a)}function r(e,s,n,i,r,o,a){return t(n^(s|~i),e,s,r,o,a)}function o(e,t){var o=e[0],a=e[1],h=e[2],c=e[3];o=s(o,a,h,c,t[0],7,-680876936),c=s(c,o,a,h,t[1],12,-389564586),h=s(h,c,o,a,t[2],17,606105819),a=s(a,h,c,o,t[3],22,-1044525330),o=s(o,a,h,c,t[4],7,-176418897),c=s(c,o,a,h,t[5],12,1200080426),h=s(h,c,o,a,t[6],17,-1473231341),a=s(a,h,c,o,t[7],22,-45705983),o=s(o,a,h,c,t[8],7,1770035416),c=s(c,o,a,h,t[9],12,-1958414417),h=s(h,c,o,a,t[10],17,-42063),a=s(a,h,c,o,t[11],22,-1990404162),o=s(o,a,h,c,t[12],7,1804603682),c=s(c,o,a,h,t[13],12,-40341101),h=s(h,c,o,a,t[14],17,-1502002290),a=s(a,h,c,o,t[15],22,1236535329),o=n(o,a,h,c,t[1],5,-165796510),c=n(c,o,a,h,t[6],9,-1069501632),h=n(h,c,o,a,t[11],14,643717713),a=n(a,h,c,o,t[0],20,-373897302),o=n(o,a,h,c,t[5],5,-701558691),c=n(c,o,a,h,t[10],9,38016083),h=n(h,c,o,a,t[15],14,-660478335),a=n(a,h,c,o,t[4],20,-405537848),o=n(o,a,h,c,t[9],5,568446438),c=n(c,o,a,h,t[14],9,-1019803690),h=n(h,c,o,a,t[3],14,-187363961),a=n(a,h,c,o,t[8],20,1163531501),o=n(o,a,h,c,t[13],5,-1444681467),c=n(c,o,a,h,t[2],9,-51403784),h=n(h,c,o,a,t[7],14,1735328473),a=n(a,h,c,o,t[12],20,-1926607734),o=i(o,a,h,c,t[5],4,-378558),c=i(c,o,a,h,t[8],11,-2022574463),h=i(h,c,o,a,t[11],16,1839030562),a=i(a,h,c,o,t[14],23,-35309556),o=i(o,a,h,c,t[1],4,-1530992060),c=i(c,o,a,h,t[4],11,1272893353),h=i(h,c,o,a,t[7],16,-155497632),a=i(a,h,c,o,t[10],23,-1094730640),o=i(o,a,h,c,t[13],4,681279174),c=i(c,o,a,h,t[0],11,-358537222),h=i(h,c,o,a,t[3],16,-722521979),a=i(a,h,c,o,t[6],23,76029189),o=i(o,a,h,c,t[9],4,-640364487),c=i(c,o,a,h,t[12],11,-421815835),h=i(h,c,o,a,t[15],16,530742520),a=i(a,h,c,o,t[2],23,-995338651),o=r(o,a,h,c,t[0],6,-198630844),c=r(c,o,a,h,t[7],10,1126891415),h=r(h,c,o,a,t[14],15,-1416354905),a=r(a,h,c,o,t[5],21,-57434055),o=r(o,a,h,c,t[12],6,1700485571),c=r(c,o,a,h,t[3],10,-1894986606),h=r(h,c,o,a,t[10],15,-1051523),a=r(a,h,c,o,t[1],21,-2054922799),o=r(o,a,h,c,t[8],6,1873313359),c=r(c,o,a,h,t[15],10,-30611744),h=r(h,c,o,a,t[6],15,-1560198380),a=r(a,h,c,o,t[13],21,1309151649),o=r(o,a,h,c,t[4],6,-145523070),c=r(c,o,a,h,t[11],10,-1120210379),h=r(h,c,o,a,t[2],15,718787259),a=r(a,h,c,o,t[9],21,-343485551),e[0]=b(o,e[0]),e[1]=b(a,e[1]),e[2]=b(h,e[2]),e[3]=b(c,e[3])}function a(e){var t,s=[];for(t=0;64>t;t+=4)s[t>>2]=e.charCodeAt(t)+(e.charCodeAt(t+1)<<8)+(e.charCodeAt(t+2)<<16)+(e.charCodeAt(t+3)<<24);return s}function h(e){var t,s=[];for(t=0;64>t;t+=4)s[t>>2]=e[t]+(e[t+1]<<8)+(e[t+2]<<16)+(e[t+3]<<24);return s}function c(e){var t,s,n,i,r,h,c=e.length,u=[1732584193,-271733879,-1732584194,271733878];for(t=64;c>=t;t+=64)o(u,a(e.substring(t-64,t)));for(e=e.substring(t-64),s=e.length,n=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],t=0;s>t;t+=1)n[t>>2]|=e.charCodeAt(t)<<(t%4<<3);if(n[t>>2]|=128<<(t%4<<3),t>55)for(o(u,n),t=0;16>t;t+=1)n[t]=0;return i=8*c,i=i.toString(16).match(/(.*?)(.{0,8})$/),r=parseInt(i[2],16),h=parseInt(i[1],16)||0,n[14]=r,n[15]=h,o(u,n),u}function u(e){var t,s,n,i,r,a,c=e.length,u=[1732584193,-271733879,-1732584194,271733878];for(t=64;c>=t;t+=64)o(u,h(e.subarray(t-64,t)));for(e=c>t-64?e.subarray(t-64):new Uint8Array(0),s=e.length,n=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],t=0;s>t;t+=1)n[t>>2]|=e[t]<<(t%4<<3);if(n[t>>2]|=128<<(t%4<<3),t>55)for(o(u,n),t=0;16>t;t+=1)n[t]=0;return i=8*c,i=i.toString(16).match(/(.*?)(.{0,8})$/),r=parseInt(i[2],16),a=parseInt(i[1],16)||0,n[14]=r,n[15]=a,o(u,n),u}function d(e){var t,s="";for(t=0;4>t;t+=1)s+=S[e>>8*t+4&15]+S[e>>8*t&15];return s}function l(e){var t;for(t=0;t<e.length;t+=1)e[t]=d(e[t]);return e.join("")}function _(e){return/[\u0080-\uFFFF]/.test(e)&&(e=unescape(encodeURIComponent(e))),e}function p(e,t){var s,n=e.length,i=new ArrayBuffer(n),r=new Uint8Array(i);for(s=0;n>s;s++)r[s]=e.charCodeAt(s);return t?r:i}function m(e){return String.fromCharCode.apply(null,new Uint8Array(e))}function f(e,t,s){var n=new Uint8Array(e.byteLength+t.byteLength);return n.set(new Uint8Array(e)),n.set(new Uint8Array(t),e.byteLength),s?n:n.buffer}function g(){this.reset()}var b=function(e,t){return e+t&4294967295},S=["0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f"];return"5d41402abc4b2a76b9719d911017c592"!==l(c("hello"))&&(b=function(e,t){var s=(65535&e)+(65535&t),n=(e>>16)+(t>>16)+(s>>16);return n<<16|65535&s}),g.prototype.append=function(e){return this.appendBinary(_(e)),this},g.prototype.appendBinary=function(e){this._buff+=e,this._length+=e.length;var t,s=this._buff.length;for(t=64;s>=t;t+=64)o(this._hash,a(this._buff.substring(t-64,t)));return this._buff=this._buff.substring(t-64),this},g.prototype.end=function(e){var t,s,n=this._buff,i=n.length,r=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];for(t=0;i>t;t+=1)r[t>>2]|=n.charCodeAt(t)<<(t%4<<3);return this._finish(r,i),s=e?this._hash:l(this._hash),this.reset(),s},g.prototype.reset=function(){return this._buff="",this._length=0,this._hash=[1732584193,-271733879,-1732584194,271733878],this},g.prototype.getState=function(){return{buff:this._buff,length:this._length,hash:this._hash}},g.prototype.setState=function(e){return this._buff=e.buff,this._length=e.length,this._hash=e.hash,this},g.prototype.destroy=function(){delete this._hash,delete this._buff,delete this._length},g.prototype._finish=function(e,t){var s,n,i,r=t;if(e[r>>2]|=128<<(r%4<<3),r>55)for(o(this._hash,e),r=0;16>r;r+=1)e[r]=0;s=8*this._length,s=s.toString(16).match(/(.*?)(.{0,8})$/),n=parseInt(s[2],16),i=parseInt(s[1],16)||0,e[14]=n,e[15]=i,o(this._hash,e)},g.hash=function(e,t){return g.hashBinary(_(e),t)},g.hashBinary=function(e,t){var s=c(e);return t?s:l(s)},g.ArrayBuffer=function(){this.reset()},g.ArrayBuffer.prototype.append=function(e){var t,s=f(this._buff.buffer,e,!0),n=s.length;for(this._length+=e.byteLength,t=64;n>=t;t+=64)o(this._hash,h(s.subarray(t-64,t)));return this._buff=n>t-64?s.subarray(t-64):new Uint8Array(0),this},g.ArrayBuffer.prototype.end=function(e){var t,s,n=this._buff,i=n.length,r=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];for(t=0;i>t;t+=1)r[t>>2]|=n[t]<<(t%4<<3);return this._finish(r,i),s=e?this._hash:l(this._hash),this.reset(),s},g.ArrayBuffer.prototype.reset=function(){return this._buff=new Uint8Array(0),this._length=0,this._hash=[1732584193,-271733879,-1732584194,271733878],this},g.ArrayBuffer.prototype.getState=function(){var e=g.prototype.getState.call(this);return e.buff=m(e.buff),e},g.ArrayBuffer.prototype.setState=function(e){return e.buff=p(e.buff,!0),g.prototype.setState.call(this,e)},g.ArrayBuffer.prototype.destroy=g.prototype.destroy,g.ArrayBuffer.prototype._finish=g.prototype._finish,g.ArrayBuffer.hash=function(e,t){var s=u(new Uint8Array(e));return t?s:l(s)},g}),function(e){"use strict";function t(e,t){return new r.Builder(e,t)}function s(e){return new r.Builder("message",e)}function n(e){return new r.Builder("iq",e)}function i(e){return new r.Builder("presence",e)}var r,o="Strophe.Builder - ",a="Strophe.Connection - ",h="Strophe.Handler - ",c="Strophe.Request - ",u=msos.config.verbose,d=msos.console.debug,l=0;for(r={VERSION:"1.2.3",onIdle_delay:333,NS:{HTTPBIND:"http://jabber.org/protocol/httpbind",BOSH:"urn:xmpp:xbosh",CLIENT:"jabber:client",AUTH:"jabber:iq:auth",ROSTER:"jabber:iq:roster",PROFILE:"jabber:iq:profile",DISCO_INFO:"http://jabber.org/protocol/disco#info",DISCO_ITEMS:"http://jabber.org/protocol/disco#items",MUC:"http://jabber.org/protocol/muc",SASL:"urn:ietf:params:xml:ns:xmpp-sasl",STREAM:"http://etherx.jabber.org/streams",FRAMING:"urn:ietf:params:xml:ns:xmpp-framing",BIND:"urn:ietf:params:xml:ns:xmpp-bind",SESSION:"urn:ietf:params:xml:ns:xmpp-session",VERSION:"jabber:iq:version",STANZAS:"urn:ietf:params:xml:ns:xmpp-stanzas",XHTML_IM:"http://jabber.org/protocol/xhtml-im",XHTML:"http://www.w3.org/1999/xhtml"},XHTML:{tags:["a","blockquote","br","cite","em","img","li","ol","p","span","strong","ul","body"],attributes:{a:["href"],blockquote:["style"],br:[],cite:["style"],em:[],img:["src","alt","style","height","width"],li:["style"],ol:["style"],p:["style"],span:["style"],strong:[],ul:["style"],body:[]},css:["background-color","color","font-family","font-size","font-style","font-weight","margin-left","margin-right","text-align","text-decoration"],validTag:function(e){var t=0;for(t=0;t<r.XHTML.tags.length;t+=1)if(e===r.XHTML.tags[t])return!0;return!1},validAttribute:function(e,t){var s=0;if(void 0!==r.XHTML.attributes[e]&&r.XHTML.attributes[e].length>0)for(s=0;s<r.XHTML.attributes[e].length;s+=1)if(t===r.XHTML.attributes[e][s])return!0;return!1},validCSS:function(e){var t=0;for(t=0;t<r.XHTML.css.length;t+=1)if(e===r.XHTML.css[t])return!0;return!1}},addNamespace:function(e,t){r.NS[e]=t},status_name:["ERROR","CONNECTING","CONNFAIL","AUTHENTICATING","AUTHFAIL","CONNECTED","DISCONNECTED","DISCONNECTING","ATTACHED","REDIRECT"],Status:{},ElementType:{NORMAL:1,TEXT:3,CDATA:4,FRAGMENT:11},TIMEOUT:1.1,SECONDARY_TIMEOUT:.1,_xmlGenerator:null,xmlGenerator:function(){if(!r._xmlGenerator){var e=document.implementation.createDocument("jabber:client","strophe",null);r._xmlGenerator=e}return r._xmlGenerator},xmlElement:function(e){if(!e)return null;var t,s,n=r.xmlGenerator().createElement(e),i=0,o=0,a="";for(i=1;i<arguments.length;i+=1)if(t=arguments[i],!msos.var_is_empty(t))if("string"==typeof t||"number"==typeof t)n.appendChild(r.xmlTextNode(t));else if("object"==typeof t&&"function"==typeof t.sort)for(o=0;o<t.length;o+=1)s=t[o],"object"==typeof s&&"function"==typeof s.sort&&void 0!==s[1]&&null!==s[1]&&n.setAttribute(s[0],s[1]);else if("object"==typeof t)for(a in t)t.hasOwnProperty(a)&&void 0!==t[a]&&null!==t[a]&&n.setAttribute(a,t[a]);return n},xmlescape:function(e){return msos.var_is_empty(e)?(msos.console.warn("Strophe.xmlescape -> missing input!"),""):(e=e.replace(/\&/g,"&amp;"),e=e.replace(/</g,"&lt;"),e=e.replace(/>/g,"&gt;"),e=e.replace(/'/g,"&apos;"),e=e.replace(/"/g,"&quot;"))},xmlunescape:function(e){return msos.var_is_empty(e)?(msos.console.warn("Strophe.unxmlescape -> missing input!"),""):(e=e.replace(/\&amp;/g,"&"),e=e.replace(/&lt;/g,"<"),e=e.replace(/&gt;/g,">"),e=e.replace(/&apos;/g,"'"),e=e.replace(/&quot;/g,'"'))},xmlTextNode:function(e){return r.xmlGenerator().createTextNode(e)},xmlHtmlNode:function(e){var t,s;return window.DOMParser?(s=new DOMParser,t=s.parseFromString(e,"text/xml")):(t=new ActiveXObject("Microsoft.XMLDOM"),t.async="false",t.loadXML(e)),t},getText:function(e){if(!e)return null;var t="",s=0;for(0===e.childNodes.length&&e.nodeType===r.ElementType.TEXT&&(t+=e.nodeValue),s=0;s<e.childNodes.length;s+=1)e.childNodes[s].nodeType===r.ElementType.TEXT&&(t+=e.childNodes[s].nodeValue);return r.xmlescape(t)},copyElement:function(e){var t,s=0;if(e.nodeType===r.ElementType.NORMAL){for(t=r.xmlElement(e.tagName),s=0;s<e.attributes.length;s+=1)t.setAttribute(e.attributes[s].nodeName,e.attributes[s].value);for(s=0;s<e.childNodes.length;s+=1)t.appendChild(r.copyElement(e.childNodes[s]))}else e.nodeType===r.ElementType.TEXT&&(t=r.xmlGenerator().createTextNode(e.nodeValue));return t},createHtml_def_length:1e3,createHtml_max_length:1e3,createHtml_cur_length:0,createHtml:function(e,t){var s,n,i,o,a,h,c,u,l,_,p,m,f,g=0,b=0;if(d("Strophe.createHtml -> called, child: "+(t?"true":"false")),e&&e.nodeType===r.ElementType.NORMAL)if(n=e.nodeName.toLowerCase(),r.XHTML.validTag(n))try{for(s=r.xmlElement(n),g=0;g<r.XHTML.attributes[n].length;g+=1)if(i=r.XHTML.attributes[n][g],o=e.getAttribute(i),!msos.var_is_empty(o)&&o!==!1&&0!==o)if("style"===i&&"object"==typeof o&&void 0!==o.cssText&&(o=o.cssText),"style"===i){for(a=[],h=o.split(";"),b=0;b<h.length;b+=1)c=h[b].split(":"),u=c[0].replace(/^\s*/,"").replace(/\s*$/,"").toLowerCase(),r.XHTML.validCSS(u)&&(l=c[1].replace(/^\s*/,"").replace(/\s*$/,""),a.push(u+": "+l));a.length>0&&(o=a.join("; "),s.setAttribute(i,o))}else s.setAttribute(i,o);for(g=0;g<e.childNodes.length;g+=1)s.appendChild(r.createHtml(e.childNodes[g]),!0)}catch(S){s=r.xmlTextNode(""),msos.console.warn("Strophe - createHtml -> invalid elements in: "+n+", error: "+S)}else for(s=r.xmlGenerator().createDocumentFragment(),g=0;g<e.childNodes.length;g+=1)s.appendChild(r.createHtml(e.childNodes[g]),!0);else if(e&&e.nodeType===r.ElementType.FRAGMENT)for(s=r.xmlGenerator().createDocumentFragment(),g=0;g<e.childNodes.length;g+=1)s.appendChild(r.createHtml(e.childNodes[g]),!0);else{if(!e||e.nodeType!==r.ElementType.TEXT)return void msos.console.error("Strophe - createHtml -> missing input element!");_=e.nodeValue,p=r.createHtml_cur_length,m=r.createHtml_cur_length+_.length,m>r.createHtml_max_length?(f=r.createHtml_max_length-p,r.createHtml_cur_length+=f,_=_.substring(0,f),_+="...",d("Strophe - createHtml -> cropped total text to: "+r.createHtml_max_length)):r.createHtml_cur_length=m,s=r.xmlTextNode(_)}return t!==!0&&(r.createHtml_max_length=r.createHtml_def_length,r.createHtml_cur_length=0),s},escapeNode:function(e){return msos.var_is_empty(e)?(msos.console.warn("Strophe.escapeNode -> missing input!"),""):"string"!=typeof e?(msos.console.warn("Strophe.escapeNode -> input not a string!"),e):e.replace(/^\s+|\s+$/g,"").replace(/\\/g,"\\5c").replace(/ /g,"\\20").replace(/\"/g,"\\22").replace(/\&/g,"\\26").replace(/\'/g,"\\27").replace(/\//g,"\\2f").replace(/:/g,"\\3a").replace(/</g,"\\3c").replace(/>/g,"\\3e").replace(/@/g,"\\40")},unescapeNode:function(e){return msos.var_is_empty(e)?(msos.console.warn("Strophe.unescapeNode -> missing input!"),""):"string"!=typeof e?(msos.console.warn("Strophe.unescapeNode -> input not a string!"),e):e.replace(/\\20/g," ").replace(/\\22/g,'"').replace(/\\26/g,"&").replace(/\\27/g,"'").replace(/\\2f/g,"/").replace(/\\3a/g,":").replace(/\\3c/g,"<").replace(/\\3e/g,">").replace(/\\40/g,"@").replace(/\\5c/g,"\\")},getNodeFromJid:function(e){var t,s="Strophe.getNodeFromJid -> ";return"strophe"===u&&d(s+"start, jid: "+e),t=e.indexOf("@")<0?null:e.split("@")[0],"strophe"===u&&d(s+"done, node: "+t),t},getDomainFromJid:function(e){var t,s,n="Strophe.getDomainFromJid -> ",i=[];return"strophe"===u&&d(n+"start, jid: "+e),t=r.getBareJidFromJid(e),t.indexOf("@")<0?s=t:(i=t.split("@"),i.splice(0,1),s=i.join("@")),"strophe"===u&&d(n+"done, domain: "+s),s},getResourceFromJid:function(e){var t,s="Strophe.getResourceFromJid -> ",n=e.split("/");return"strophe"===u&&d(s+"start, input jid: "+e),n.length<2?t=null:(n.splice(0,1),t=n.join("/")),"strophe"===u&&d(s+"done, resource: "+t),t},getBareJidFromJid:function(e){var t=e?e.split("/")[0]:null;return"strophe"===u&&d("Strophe.getBareJidFromJid -> called, jid (in): "+e+", bare (out): "+t),t},serialize:function(e){return"function"==typeof e.tree&&(e=e.tree()),jQuery(e)[0].outerHTML},_requestId:0,_connectionPlugins:{},addConnectionPlugin:function(e,t){r._connectionPlugins[e]=t}},l=0;l<r.status_name.length;l+=1)r.Status[r.status_name[l]]=l;r.Builder=function(e,t){("presence"===e||"message"===e||"iq"===e)&&(t&&!t.xmlns?t.xmlns=r.NS.CLIENT:t||(t={xmlns:r.NS.CLIENT})),this.nodeTree=r.xmlElement(e,t),this.node=this.nodeTree},r.Builder.prototype={tree:function(){return this.nodeTree},toString:function(){return r.serialize(this.nodeTree)},up:function(){return this.node=this.node.parentNode,this},attrs:function(e){var t="";for(t in e)e.hasOwnProperty(t)&&(void 0===e[t]?this.node.removeAttribute(t):this.node.setAttribute(t,e[t]));return this},c:function(e,t,s){var n=r.xmlElement(e,t,s);return this.node.appendChild(n),"string"!=typeof s&&(this.node=n),this},cnode:function(e){var t,s=r.xmlGenerator(),n=!1;try{n=void 0!==s.importNode}catch(i){n=!1,msos.console.warn(o+"cnode -> error: "+i)}return t=n?s.importNode(e,!0):r.copyElement(e),this.node.appendChild(t),this.node=t,this},t:function(e){var t=r.xmlTextNode(e);return this.node.appendChild(t),this},h:function(e){var t,s=document.createElement("body");for(s.innerHTML=e,t=r.createHtml(s);t.childNodes.length>0;)this.node.appendChild(t.childNodes[0]);return this}},r.Handler=function(e,t,s,n,i,r){return this.handler=e,this.ns=t,this.name=s,this.type=n||!1,this.id=i||!1,this.from=r||!1,this.user=!0,this.describe="",this},r.Handler.prototype={isMatch:function(e){var t=jQuery(e),s=!1,n=this;return this.ns?(s=t.attr("xmlns")===this.ns,s||t.children().each(function(e,t){var i=jQuery(t);i.attr("xmlns")===n.ns&&(s=!0)})):s=!0,!s||this.name&&t.prop("tagName").toLowerCase()!==this.name||this.type&&(_.isArray(this.type)?-1===_.indexOf(this.type,t.attr("type")):t.attr("type")!==this.type)||this.id&&t.attr("id")!==this.id||this.from&&t.attr("from")!==this.from?!1:!0},run:function(e){var t=null;u&&d(h+"run -> start, handler:\n    "+this.toString());try{t=this.handler(e)||!1}catch(s){msos.console.error(s.sourceURL?h+"run -> error w/url: "+s.sourceURL+":"+s.line+" - "+s.name+": "+s.message+"\n for handler: "+this.toString():s.fileName?h+"run -> error w/file: "+s.fileName+":"+s.lineNumber+" - "+s.name+": "+s.message+"\n for handler: "+this.toString():s.stack?h+"run -> error w/stack: "+s.stack+"\n for handler: "+this.toString():h+"run -> error plain: "+s.message+"\n for handler: "+this.toString())}return u&&d(h+"run -> done!"),t},toString:function(){return"ns: "+this.ns+", name: "+this.name+", type: "+(_.isArray(this.type)?this.type.join(" or "):this.type)+", id: "+this.id+", from: "+this.from+", user: "+this.user+(this.describe?", desc: "+this.describe:"")}},r.TimedHandler=function(e,t){this.period=e,this.handler=t,this.lastCalled=(new Date).getTime(),this.user=!0},r.TimedHandler.prototype={run:function(){return this.lastCalled=(new Date).getTime(),this.handler()},reset:function(){this.lastCalled=(new Date).getTime()},toString:function(){return"{ TimedHandler: "+this.handler+"("+this.period+") }"}},r.Connection=function(e,t){this.service=e,this.options=t||{},this.jid="",this.domain=null,this.features=null,this.rid=Math.floor(4294967295*Math.random()),this.sid=null,this.streamId=null,this.resource=null,this._sasl_data={},this.do_session=!1,this.do_bind=!1,this.timedHandlers=[],this.handlers=[],this.removeTimeds=[],this.removeHandlers=[],this.addTimeds=[],this.addHandlers=[],this._authentication={},this._idleTimeout=null,this._disconnectTimeout=null,this.do_authentication=!0,this.authenticated=!1,this.disconnecting=!1,this.connected=!1,this.errors=0,this.paused=!1,this.restored=!1,this.hold=1,this.wait=60,this.window=5,this.ws=null,this.connect_timeout=300,this._keep_alive_timer=2e4,this._data=[],this._requests=[],this._sasl_success_handler=null,this._sasl_failure_handler=null,this._sasl_challenge_handler=null,this.maxRetries=5,this._idleTimeout=setTimeout(_.bind(this._onIdle,this),r.onIdle_delay);var s,n,i="";for(i in r._connectionPlugins)s=r._connectionPlugins[i],n=function(){},n.prototype=s,this[i]=new n,this[i].init(this)},r.Connection.prototype={pause:function(){this.paused=!0},resume:function(){this.paused=!1},debug_count:0,getUniqueId:function(e){var t,s,n="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx",i="4xx-yxx";return msos.config.debug?(this.debug_count+=1,s=String(10*this.debug_count)+"-"+i):s=n,t=s.replace(/[xy]/g,function(e){var t=16*Math.random()|0,s="x"==e?t:3&t|8;return s.toString(16)}),("string"==typeof e||"number"==typeof e)&&(t+=":"+e),String(t)},debugInput:function(e){u&&(d(a+".debugInput\n<<<<",e),d("<<<<"))},debugOutput:function(e){u&&d(a+".debugOutput\n>>>>\n"+e+"\n>>>>")},mechanisms:{},_changeConnectStatus:function(e,t){var s,n,i="_changeConnectStatus -> ",o="",h=r.status_name[e],c="callback.";u&&d(a+i+"start, status: "+h);for(o in r._connectionPlugins)s=this[o],s.statusChanged&&(n=s.statusChanged(e,t),u&&d(a+i+"plugin: "+o+", initialized: "+n));"function"==typeof this.connect_callback?(this.connect_callback(e,t),c="w/ "+c):c="w/o "+c,u&&d(a+i+" done, status: "+h+", "+(t?t+", ":"")+c)},authenticate:function(e){var s,n,i,o,h="authenticate -> ",c=0,l=0,p=!1;for(u&&d(a+h+"start, matched length: "+e.length),c=0;c<e.length-1;c+=1){for(i=c,l=c+1;l<e.length;l+=1)e[l].priority>e[i].priority&&(i=l);i>l&&(o=e[c],e[c]=e[i],e[i]=o)}for(c=0;c<e.length;c+=1)"function"==typeof e[c].test&&e[c].test(this)&&(this._sasl_success_handler=this.addStropheHandler(_.bind(this._sasl_success_cb,this),r.NS.SASL,"success"),this._sasl_success_handler.user=!1,this._sasl_failure_handler=this.addStropheHandler(_.bind(this._sasl_failure_cb,this),r.NS.SASL,"failure"),this._sasl_failure_handler.user=!1,this._sasl_challenge_handler=this.addStropheHandler(_.bind(this._sasl_challenge_cb,this),r.NS.SASL,"challenge"),this._sasl_challenge_handler.user=!1,this._sasl_mechanism=new e[c],this._sasl_mechanism.onStart(this),s=t("auth",{xmlns:r.NS.SASL,mechanism:this._sasl_mechanism.name}),this._sasl_mechanism.isClientFirst&&(n=this._sasl_mechanism.onChallenge(this,null),s.t(Base64.encode(n))),this.send(s.tree()),p=!0,d(a+h+"mechanism found: "+this._sasl_mechanism.name));p?this._changeConnectStatus(r.Status.AUTHENTICATING,null):(msos.console.error(a+h+"no authorization mechanisms found."),this._changeConnectStatus(r.Status.CONNFAIL,"strophe_no_auth_mechanism"),this.server_disconnect("strophe_no_auth_mechanism")),u&&d(a+h+"done!")},sendIQ:function(e,t,s,n,i){var o,h,c,l="sendIQ -> ",_=null,p=this,m="";return d(a+l+"start, description: '"+t+"'"),"function"==typeof e.tree&&(e=e.tree()),m=e.getAttribute("id"),m||(m=this.getUniqueId("sendIQ"),e.setAttribute("id",m)),o=e.getAttribute("to"),h=this.jid,c=this.addStropheHandler(function(e){_&&p.deleteTimedHandler(_);var t,i=!1,c=e.getAttribute("from");return(c===o||null===o&&(c===r.getBareJidFromJid(h)||c===r.getDomainFromJid(h)||c===h))&&(i=!0),i?(t=e.getAttribute("type"),void("result"===t?(u&&d(a+l+"success, id: "+m),s&&s(e)):"error"===t?(u&&d(a+l+"error, id: "+m),n&&n(e)):msos.console.error(a+l+"failed, id: "+m+", for bad IQ type: "+t))):(msos.console.error(a+l+"failed, response jid: "+c+", for jid: "+o),void this._changeConnectStatus(r.Status.ERROR,"strophe_invalid_id"))},r.NS.CLIENT,"iq",["error","result"],m),c.describe=t,i&&(_=this.addTimedHandler(i,function(){return p.deleteHandler(c),n&&n(null),!1})),this.send(e),d(a+l+"done, id: "+m),m},_sasl_challenge_cb:function(e){var s=Base64.decode(r.getText(e)),n=this._sasl_mechanism.onChallenge(this,s);return this.send(t("response",{xmlns:r.NS.SASL}).t(Base64.encode(n)).tree()),!0},_sasl_auth1_cb:function(e){var t,s,i,o=0;for(u&&d(a+"_sasl_auth1_cb -> start."),o=0;o<e.childNodes.length;o+=1)t=e.childNodes[o],"bind"===t.nodeName&&(this.do_bind=!0),"session"===t.nodeName&&(this.do_session=!0);return this.do_bind?(i=this.addStropheHandler(_.bind(this._sasl_bind_cb,this),r.NS.CLIENT,"iq",["error","result"],"_bind_auth_2"),i.user=!1,s=r.getResourceFromJid(this.jid),this.send(s?n({type:"set",id:"_bind_auth_2"}).c("bind",{xmlns:r.NS.BIND}).c("resource",{}).t(s).tree():n({type:"set",id:"_bind_auth_2"}).c("bind",{xmlns:r.NS.BIND}).tree()),u&&d(a+"_sasl_auth1_cb -> done!"),!1):(this._changeConnectStatus(r.Status.AUTHFAIL,"strophe_auth_failed"),d(a+"_sasl_auth1_cb -> done, AUTHFAIL"),!1)},_sasl_bind_cb:function(e){var t,s,i,o,h,c,l,p,m="sasl_auth_bind_error";return u&&d(a+"_sasl_bind_cb -> start."),"error"===e.getAttribute("type")?(p=e.getElementsByTagName("conflict"),p.length>0&&(m="sasl_auth_bind_conflict"),this._changeConnectStatus(r.Status.AUTHFAIL,m),u&&d(a+"_sasl_bind_cb -> done, SASL binding failed."),!1):(t=e.getElementsByTagName("bind"),t.length>0&&(s=t[0].getElementsByTagName("jid"),s.length>0)?(i=r.getText(s[0]),o=r.getNodeFromJid(i),h=r.getDomainFromJid(i),c=r.getResourceFromJid(i),o===c?this.jid=o+"@"+h+"/"+c:(msos.console.warn(a+"_sasl_bind_cb -> using jid w/o domain or resource: "+i),this.jid=i),this.do_session?(l=this.addStropheHandler(_.bind(this._sasl_session_cb,this),r.NS.CLIENT,"iq",["error","result"],"_session_auth_2"),l.user=!1,this.send(n({type:"set",id:"_session_auth_2"}).c("session",{xmlns:r.NS.SESSION}).tree())):(this.authenticated=!0,this._changeConnectStatus(r.Status.CONNECTED,null)),u&&d(a+"_sasl_bind_cb -> done, node count: "+s.length),!1):(msos.console.warn(a+"_sasl_bind_cb -> done, SASL binding failed."),!0))},_sasl_session_cb:function(e){if(u&&d(a+"_sasl_session_cb -> start."),"result"===e.getAttribute("type"))this.authenticated=!0,this._changeConnectStatus(r.Status.CONNECTED,null);else if("error"===e.getAttribute("type"))return msos.console.warn(a+"_sasl_session_cb -> session creation failed."),this._changeConnectStatus(r.Status.AUTHFAIL,"sasl_session_failed"),!0;return u&&d(a+"_sasl_session_cb -> done!"),!1},_sasl_failure_cb:function(e){return u&&d(a+"_sasl_failure_cb -> start."),this._sasl_success_handler&&(this.deleteHandler(this._sasl_success_handler),this._sasl_success_handler=null),this._sasl_challenge_handler&&(this.deleteHandler(this._sasl_challenge_handler),this._sasl_challenge_handler=null),this._sasl_mechanism&&this._sasl_mechanism.onFailure(),this._changeConnectStatus(r.Status.AUTHFAIL,"sasl_server_failed"),u&&d(a+"_sasl_failure_cb -> done!"),!1},addTimedHandler:function(e,t){var s=new r.TimedHandler(e,t);return this.addTimeds.push(s),s},deleteTimedHandler:function(e){this.removeTimeds.push(e)},deleteHandler:function(e){this.removeHandlers.push(e)},addStropheHandler:function(e,t,s,n,i,o){var h=new r.Handler(e,t,s,n,i,o);return this.addHandlers.push(h),u&&d(a+"addStropheHandler -> called, added:\n    "+h.toString()),h},_addSysTimedHandler:function(e,t){var s=new r.TimedHandler(e,t);return s.user=!1,this.addTimeds.push(s),s},_queueData:function(e){null!==e&&e.tagName&&e.childNodes?this._data.push(e):msos.console.error(a+"_queueData -> can not queue non-DOMElement."),u&&d(a+"_queueData -> called, queued requests: "+this._data.length)},_sasl_success_cb:function(e){var t,s,n,i,o,h,c=/([a-z]+)=([^,]+)(,|$)/,l=[],p=[],m=this;return u&&d(a+"_sasl_success_cb -> start."),this._sasl_data["server-signature"]&&(s=Base64.decode(r.getText(e)),l=s.match(c),"v"===l[1]&&(t=l[2]),t!==this._sasl_data["server-signature"])?(this.deleteHandler(this._sasl_failure_handler),this._sasl_failure_handler=null,this._sasl_challenge_handler&&(this.deleteHandler(this._sasl_challenge_handler),this._sasl_challenge_handler=null),this._sasl_data={},d(a+"_sasl_success_cb -> done, failed!"),this._sasl_failure_cb(null)):(u&&d(a+"_sasl_success_cb -> SASL authentication succeeded."),this._sasl_mechanism&&this._sasl_mechanism.onSuccess(),this.deleteHandler(this._sasl_failure_handler),this._sasl_failure_handler=null,this._sasl_challenge_handler&&(this.deleteHandler(this._sasl_challenge_handler),this._sasl_challenge_handler=null),o=function(e,t){for(var s=_.bind(m._sasl_auth1_cb,m);e.length;)m.deleteHandler(e.pop());return s(t),!1},n=this.addStropheHandler(function(e){o(p,e)},!1,"stream:features"),n.user=!1,p.push(n),i=this.addStropheHandler(function(e){o(p,e)},r.NS.STREAM,"features"),i.user=!1,p.push(i),h=_.bind(this._onIdle,this),this._data.push("restart"),clearTimeout(this._idleTimeout),this._throttledRequestHandler(),this._idleTimeout=setTimeout(h,r.onIdle_delay),u&&d(a+"_sasl_success_cb -> done!"),!1)},_dataRecv:function(e){var t,s,n,i,o,h,c,l="_dataRecv -> ",p=0,m=this;d(a+l+"start, add: "+this.addHandlers.length+", remove: "+this.removeHandlers.length+" handlers.");try{t=e.getResponse()}catch(f){return msos.console.error(a+l+"error:",f),void this.server_disconnect("strophe_parsererror")}if(msos.var_is_empty(t))return void msos.console.warn(a+l+"done, no stanza");if(this.debugInput(t),this.disconnecting&&0===this._requests.length)return this.deleteTimedHandler(this._disconnectTimeout),this._disconnectTimeout=null,this.client_disconnect(),void d(a+l+"done, graceful disconnect.");for(;this.removeHandlers.length>0;)i=this.removeHandlers.pop(),p=_.indexOf(this.handlers,i),p>=0&&(s=this.handlers.splice(p,1),u&&d(a+l+"removed:\n    "+s.toString()));for(;this.addHandlers.length>0;)n=this.addHandlers.pop(),this.handlers.push(n),u&&d(a+l+"added:\n    "+n.toString());return o=t.getAttribute("type"),null!==o&&"terminate"===o?this.disconnecting?void d(a+l+"done, too late to process."):(h=t.getAttribute("condition"),c=t.getElementsByTagName("conflict"),null!==h?"remote-stream-error"===h&&c.length>0&&(h="strophe_stream_conflict"):h="strophe_connection_failure",this._changeConnectStatus(r.Status.CONNFAIL,h),msos.console.warn(a+l+"done, w/ problems: "+h),void this.server_disconnect(h)):(jQuery(t).children().each(function(e,t){var s,n=0;for(n=0;n<m.handlers.length;n+=1)s=m.handlers[n],!s.isMatch(t)||!m.authenticated&&s.user||(d(a+l+"processing handler:\n    "+s.toString()),s.run(t)||m.removeHandlers.push(s))}),d(a+l+"done, for handler count: "+this.handlers.length),void("strophe"===u&&jQuery.each(this.handlers,function(e,t){d(" "+e+". "+t.toString())})))},client_disconnect:function(e){var t="client_disconnect -> ";return d(a+t+"start."),"number"==typeof this._idleTimeout&&clearTimeout(this._idleTimeout),null!==this._disconnectTimeout&&(this.deleteTimedHandler(this._disconnectTimeout),this._disconnectTimeout=null),window.sessionStorage.removeItem("strophe-bosh-session"),this._changeConnectStatus(r.Status.DISCONNECTED,e),
this.connected=!1,this._abortAllRequests(),d(a+t+"done!"),new r.Connection(this.service,this.options)},_connect_cb:function(e){var t,s,n,i,o,h,c,u,l,_,p="_connect_cb -> ",m=[],f=0,g=!1;d(a+p+"start.");try{i=e.getResponse()}catch(b){return msos.console.error(a+p+"error:",b),void this.server_disconnect("strophe_parsererror")}if(!i)return void d(a+p+"done, no response.");if(this.connected=!0,this.debugInput(i),o=i.getAttribute("type"),null!==o&&"terminate"===o)return h=i.getAttribute("condition"),c=i.getElementsByTagName("conflict"),null!==h?"remote-stream-error"===h&&c.length>0&&(h="strophe_stream_conflict"):h="strophe_connection_failure",this._changeConnectStatus(r.Status.CONNFAIL,h),this.client_disconnect(h),void d(a+p+"done, processing failed for: "+h);if(this.sid||(this.sid=i.getAttribute("sid")),u=i.getAttribute("requests"),u&&(this.window=parseInt(u,10)),l=i.getAttribute("hold"),l&&(this.hold=parseInt(l,10)),_=i.getAttribute("wait"),_&&(this.wait=parseInt(_,10)),this._authentication.sasl_scram_sha1=!1,this._authentication.sasl_plain=!1,this._authentication.sasl_digest_md5=!1,this._authentication.sasl_anonymous=!1,this._authentication.legacy_auth=!1,t=i.getElementsByTagNameNS(r.NS.STREAM,"stream:features").length>0||i.getElementsByTagNameNS(r.NS.STREAM,"features").length>0,!t)return d(a+p+"failed, no stream features found!"),this._no_auth_received(),void d(a+p+"done!");if(s=i.getElementsByTagName("mechanism"),s.length>0)for(f=0;f<s.length;f+=1)n=r.getText(s[f]),this.mechanisms[n]&&m.push(this.mechanisms[n]);return this._authentication.legacy_auth=i.getElementsByTagName("auth").length>0,(g=this._authentication.legacy_auth||m.length>0)?(this.do_authentication!==!1&&this.authenticate(m),void d(a+p+"done!")):(this._no_auth_received(),void d(a+p+"done, no authentication mechanisms found!"))},connect:function(e,t,s,n,i,o,h){d(a+"connect -> start, jid: "+e),this.jid=e,this.authzid=r.getBareJidFromJid(this.jid),this.authcid=h||r.getNodeFromJid(this.jid),this.pass=t,this.servtype="xmpp",this.connect_callback=s,this.disconnecting=!1,this.connected=!1,this.authenticated=!1,this.restored=!1,this.errors=0,this.domain=r.getDomainFromJid(this.jid),this.resource=r.getResourceFromJid(this.jid),this._changeConnectStatus(r.Status.CONNECTING,null),this.wait=n||this.wait,this.hold=i||this.hold;var c=this._buildBody().attrs({to:this.domain,"xml:lang":"en",wait:this.wait,hold:this.hold,content:"text/xml; charset=utf-8",ver:"1.6","xmpp:version":"1.0","xmlns:xmpp":r.NS.BOSH});o&&c.attrs({route:o}),this._requests.push(new r.Request(c.tree(),_.bind(this._onRequestStateChange,this,_.bind(this._connect_cb,this)),c.tree().getAttribute("rid"))),this._throttledRequestHandler(),d(a+"connect -> done, jid: "+e)},server_disconnect:function(e){var t="server_disconnect -> ",s=!1;d(a+t+"start, reason: "+e),this.sid=null,this.rid=Math.floor(4294967295*Math.random()),this._changeConnectStatus(r.Status.DISCONNECTING,e),this.connected?(this.disconnecting=!0,this.authenticated&&(s=i({xmlns:r.NS.CLIENT,type:"unavailable"})),this._disconnectTimeout=this._addSysTimedHandler(3e3,_.bind(this.client_disconnect,this)),this._sendTerminate(s)):(msos.console.warn(a+t+"Strophe not connected yet."),this._abortAllRequests()),d(a+t+"done!")},send:function(e){var t=0;if(d(a+"send -> start."),msos.var_is_null(e))return void msos.console.error(a+"send -> done, missing input!");if("function"==typeof e.sort)for(t=0;t<e.length;t+=1)this._queueData(e[t]);else this._queueData("function"==typeof e.tree?e.tree():e);clearTimeout(this._idleTimeout),this._throttledRequestHandler(),this._idleTimeout=setTimeout(_.bind(this._onIdle,this),r.onIdle_delay),d(a+"send -> done!")},_onIdle:function(){for(var e,t,s,n,i,o,h="_onIdle -> ",c=0,u=this._data,l=[],p=(new Date).getTime();this.addTimeds.length>0;)this.timedHandlers.push(this.addTimeds.pop());for(;this.removeTimeds.length>0;)e=this.removeTimeds.pop(),c=_.indexOf(this.timedHandlers,e),c>=0&&this.timedHandlers.splice(c,1);for(c=0;c<this.timedHandlers.length;c+=1)e=this.timedHandlers[c],(this.authenticated||!e.user)&&(t=e.lastCalled+e.period,0>=t-p?e.run()&&l.push(e):l.push(e));if(this.timedHandlers=l,clearTimeout(this._idleTimeout),this.authenticated&&0===this._requests.length&&0===u.length&&!this.disconnecting&&(d(a+h+"no requests, sending blank."),u.push(null)),this.paused)return void d(a+h+"paused.");if(this._requests.length<2&&u.length>0){for(d(a+h+"do BOSH restart."),s=this._buildBody(),c=0;c<u.length;c+=1)null!==u[c]&&("restart"===u[c]?s.attrs({to:this.domain,"xml:lang":"en","xmpp:restart":"true","xmlns:xmpp":r.NS.BOSH}):s.cnode(u[c]).up());delete this._data,this._data=[],this._requests.push(new r.Request(s.tree(),_.bind(this._onRequestStateChange,this,_.bind(this._dataRecv,this)),s.tree().getAttribute("rid"))),this._throttledRequestHandler()}this._requests.length>0&&(n=this._requests[0].age(),null!==this._requests[0].dead&&(o=Math.floor(r.SECONDARY_TIMEOUT*this.wait),this._requests[0].timeDead()>o&&(msos.console.warn(a+h+"Request "+this._requests[0].id+" died, from inactivity for over "+o+" seconds."),this._throttledRequestHandler())),i=Math.floor(r.TIMEOUT*this.wait),n>i&&(msos.console.warn(a+h+"Request "+this._requests[0].id+" timed out, from inactivity for over "+i+" seconds."),this._throttledRequestHandler())),this.connected&&(this._idleTimeout=setTimeout(_.bind(this._onIdle,this),r.onIdle_delay))},_sendTerminate:function(e){var t,s="_sendTerminate -> ",n=this._buildBody().attrs({type:"terminate"});d(a+s+"start."),e&&n.cnode(e.tree()),t=new r.Request(n.tree(),_.bind(this._onRequestStateChange,this,_.bind(this._dataRecv,this)),n.tree().getAttribute("rid")),this._requests.push(t),this._throttledRequestHandler(),d(a+s+"done!")},attach:function(e,t,s,n,i,o,h){d(a+"attach -> start, jid: "+e+", sid: "+t+", rid: "+s),this.jid=e,this.sid=t,this.rid=s,this.connect_callback=n,this.domain=r.getDomainFromJid(this.jid),this.authenticated=!0,this.connected=!0,this.wait=i||this.wait,this.hold=o||this.hold,this.window=h||this.window,this._changeConnectStatus(r.Status.ATTACHED,null),d(a+"attach -> done!")},_buildBody:function(){this.rid+=1;var e=t("body",{rid:this.rid,xmlns:r.NS.HTTPBIND});return null!==this.sid&&e.attrs({sid:this.sid}),this.options.keepalive&&this._cacheSession(),e},_no_auth_received:function(){var e,t="_no_auth_received -> ",s=_.bind(this._connect_cb,this);d(a+t+"start."),e=this._buildBody(),this._requests.push(new r.Request(e.tree(),_.bind(this._onRequestStateChange,this,_.bind(s,this)),e.tree().getAttribute("rid"))),this._throttledRequestHandler(),d(a+t+"done!")},restore:function(e,t,s,n,i){var o;Modernizr.sessionstorage&&(o=JSON.parse(window.sessionStorage.getItem("strophe-bosh-session")),void 0!==o&&null!==o&&o.rid&&o.sid&&o.jid&&(void 0===e||r.getBareJidFromJid(o.jid)===r.getBareJidFromJid(e))?(this.restored=!0,this.attach(o.jid,o.sid,o.rid,t,s,n,i)):(msos.console.error(a+"restore -> failed, no restoreable session."),this._changeConnectStatus(r.Status.ERROR,"strophe_no_prev_session")))},_cacheSession:function(){this.authenticated?this.jid&&this.rid&&this.sid&&window.sessionStorage.setItem("strophe-bosh-session",JSON.stringify({jid:this.jid,rid:this.rid,sid:this.sid})):window.sessionStorage.removeItem("strophe-bosh-session")},_abortAllRequests:function(){for(var e;this._requests.length>0;)e=this._requests.pop(),e.abort=!0,e.xhr.abort(),e.xhr.onreadystatechange=function(){}},_removeRequest:function(e){var t;for(u&&d(a+"_removeRequest -> start."),t=this._requests.length-1;t>=0;t-=1)e===this._requests[t]&&this._requests.splice(t,1);e.xhr.onreadystatechange=function(){},this._throttledRequestHandler(),u&&d(a+"_removeRequest -> done!")},_restartRequest:function(e){var t=this._requests[e];null===t.dead&&(t.dead=new Date),this._processRequest(e)},_processRequest:function(e){var t="_processRequest -> ",s=this,n=this._requests[e],i=-1;u&&d(a+t+"start.");try{4===n.xhr.readyState&&(i=n.xhr.status)}catch(o){msos.console.warn(a+t+"request: "+e+", status: "+i+", error:",o)}if(void 0===i&&(i=-1),u&&d(a+t+"checked status: "+i),n.sends>this.maxRetries)return this.client_disconnect(),void msos.console.warn(a+t+"timed out after "+e+" tries, status: "+i);var h,c,l=n.age(),_=!isNaN(l)&&l>Math.floor(r.TIMEOUT*this.wait),p=null!==n.dead&&n.timeDead()>Math.floor(r.SECONDARY_TIMEOUT*this.wait),m=4===n.xhr.readyState&&(1>i||i>=500);if((_||p||m)&&(p&&msos.console.error(a+t+"request "+this._requests[e].id+" timed out (secondary), restarting"),n.abort=!0,n.xhr.abort(),n.xhr.onreadystatechange=function(){},this._requests[e]=new r.Request(n.xmlData,n.origFunc,n.rid,n.sends),n=this._requests[e]),0===n.xhr.readyState){d(a+t+"posting, id: "+n.id);try{n.xhr.open("POST",this.service,this.options.sync?!1:!0),n.xhr.setRequestHeader("Content-Type","text/xml; charset=utf-8")}catch(f){return msos.console.error(a+t+"XHR open failed:",f),this.connected||this._changeConnectStatus(r.Status.CONNFAIL,"strophe_xhr_bad_service"),void this.server_disconnect("strophe_xhr_bad_service")}h=function(){var e,t;if(n.date=new Date,s.options.customHeaders){e=s.options.customHeaders;for(t in e)e.hasOwnProperty(t)&&n.xhr.setRequestHeader(t,e[t])}n.xhr.send(n.data)},n.sends>1?(c=1e3*Math.min(Math.floor(r.TIMEOUT*this.wait),Math.pow(n.sends,3)),setTimeout(h,c)):h(),n.sends+=1,this.debugOutput(n.data)}else u&&d(a+t+(0===e?"first":"second")+" request with readyState: "+n.xhr.readyState);u&&d(a+t+"done!")},_throttledRequestHandler:function(){var e="_throttledRequestHandler -> ",t=0;u&&d(a+e+"start, queued request(s): "+this._requests.length),this._requests.length>0&&(this._processRequest(0),t+=1,this._requests.length>1&&Math.abs(this._requests[0].rid-this._requests[1].rid)<this.window&&(this._processRequest(1),t+=1)),u&&d(a+e+"done, for "+t+" request(s).")},_onRequestStateChange:function(e,t){var s,n,i="_onRequestStateChange -> ",o=0;if(u&&d(a+i+"start, id: "+t.id+", attempts: "+t.sends+" readyState: "+t.xhr.readyState),t.abort)return msos.console.warn(a+i+"request aborted, id: "+t.id),void(t.abort=!1);if(4===t.xhr.readyState){o=0;try{o=t.xhr.status}catch(h){msos.console.warn(a+i+"polling request status failed:",h)}if(void 0===o&&(o=0),this.disconnecting&&o>=400)return this._hitError(o),void msos.console.warn(a+i+"disconnecting with errors!");s=this._requests[0]===t,n=this._requests[1]===t,(o>0&&500>o||t.sends>5)&&(this._removeRequest(t),d(a+i+"id "+t.id+" removed for status: "+o)),200===o?((n||s&&this._requests.length>0&&this._requests[0].age()>Math.floor(r.SECONDARY_TIMEOUT*this.wait))&&this._restartRequest(0),d(a+i+"success, id: "+t.id+", attempts: "+t.sends+", status: "+o),e(t),this.errors=0):(msos.console.warn(a+i+"id "+t.id+", attempt: "+t.sends+" has error(s), status: "+o),(0===o||o>=400&&600>o||o>=12e3)&&(this._hitError(o),o>=400&&500>o&&(this._changeConnectStatus(r.Status.DISCONNECTING,"strophe_request_failure"),this.client_disconnect("strophe_request_failure")))),o>0&&500>o||t.sends>5||(msos.console.warn(a+i+"id "+t.id+", attempt: "+t.sends+", throttling requests for status: "+o),this._throttledRequestHandler())}u&&d(a+i+"done!")},_hitError:function(e){this.errors+=1,msos.console.warn(a+"_hitError -> request errored, status: "+e+", number of errors: "+this.errors),this.errors>4&&this.client_disconnect()}},r.Request=function(e,t,s,n){r._requestId+=1,this.id=r._requestId,this.xmlData=e,this.data=r.serialize(e),this.origFunc=t,this.func=t,this.rid=s,this.date=0/0,this.sends=n||0,this.abort=!1,this.dead=null,this.age=function(){if(!this.date)return 0;var e=new Date;return(e-this.date)/1e3},this.timeDead=function(){if(!this.dead)return 0;var e=new Date;return(e-this.dead)/1e3},this.xhr=this._newXHR()},r.Request.prototype={getResponse:function(){var e=null,t="getResponse -> ",s="no response.";return u&&d(c+t+"start."),this.xhr.responseXML&&this.xhr.responseXML.documentElement?(e=this.xhr.responseXML.documentElement,s="via responseXML."):this.xhr.responseText&&(e=r.xmlHtmlNode(this.xhr.responseText),s="via responseText."),e&&"parsererror"===e.tagName?(msos.console.error(c+t+"parse error: "+this.xhr.responseText),null):(u&&d(c+t+"done, "+s),e)},_newXHR:function(){var e=null;return window.XMLHttpRequest?(e=new XMLHttpRequest,e.overrideMimeType&&e.overrideMimeType("text/xml; charset=utf-8")):window.ActiveXObject&&(e=new ActiveXObject("Microsoft.XMLHTTP")),e.onreadystatechange=_.bind(this.func,null,this),e}},r.SASLMechanism=function(e,t,s){return this.name=e,this.isClientFirst=t,this.priority=s,this._sasl_mech_data={},this.test=function(e){return!0},this.onStart=function(e){this._connection=e},this.onChallenge=function(e,t){throw new Error("You should implement challenge handling!")},this.onFailure=function(){this._connection=null},this.onSuccess=function(){this._connection=null},this._quote=function(e){return msos.var_is_empty(e)?(msos.console.warn("Strophe.SASLMechanism._quote -> missing input!"),""):'"'+e.replace(/\\/g,"\\\\").replace(/"/g,'\\"')+'"'},this},r.SASLAnonymous=function(){},r.SASLAnonymous.prototype=new r.SASLMechanism("ANONYMOUS",!1,10),r.SASLAnonymous.test=function(e){return null===e.authcid},r.SASLPlain=function(){},r.SASLPlain.prototype=new r.SASLMechanism("PLAIN",!0,20),r.SASLPlain.test=function(e){return null!==e.authcid},r.SASLPlain.prototype.onChallenge=function(e,t){var s=e.authzid;return s+="\x00",s+=e.authcid,s+="\x00",s+=e.pass},r.SASLSHA1=function(){},r.SASLSHA1.prototype=new r.SASLMechanism("SCRAM-SHA-1",!0,20),r.SASLSHA1.test=function(e){return null!==e.authcid},r.SASLSHA1.prototype.onChallenge=function(e,t,s){var n=s||SparkMD5.hash(1234567890*Math.random()),i="n="+e.authcid+",r="+n;return u&&d("Strophe.SASLSHA1.onChallenge -> called."),this._sasl_mech_data.cnonce=n,this._sasl_mech_data["client-first-message-bare"]=i,i="n,,"+i,this.onChallenge=function(e,t){for(var s,n,i,r,o,a,h,c,u,d=[],l="c=biws,",_=this._sasl_mech_data["client-first-message-bare"]+","+t+",",p=this._sasl_mech_data.cnonce,m=/([a-z]+)=([^,]+)(,|$)/,f=0,g=0;t.match(m);)switch(d=t.match(m),t=t.replace(d[0],""),d[1]){case"r":s=d[2];break;case"s":n=d[2];break;case"i":i=d[2]}if(s.substr(0,p.length)!==p)return this._sasl_mech_data={},e._sasl_failure_cb();for(l+="r="+s,_+=l,n=Base64.decode(n),n+="",r=a=core_hmac_sha1(e.pass,n),f=1;i>f;f+=1){for(o=core_hmac_sha1(e.pass,binb2str(a)),g=0;5>g;g+=1)r[g]^=o[g];a=o}for(r=binb2str(r),h=core_hmac_sha1(r,"Client Key"),c=str_hmac_sha1(r,"Server Key"),u=core_hmac_sha1(str_sha1(binb2str(h)),_),e._sasl_data["server-signature"]=b64_hmac_sha1(c,_),g=0;5>g;g+=1)h[g]^=u[g];return l+=",p="+Base64.encode(binb2str(h))},_.bind(this.onChallenge,this),i},r.SASLMD5=function(){},r.SASLMD5.prototype=new r.SASLMechanism("DIGEST-MD5",!1,20),r.SASLMD5.test=function(e){return null!==e.authcid},r.SASLMD5.prototype.onChallenge=function(e,t,s){var n,i,r,o,a=/([a-z]+)=("[^"]+"|[^,"]+)(?:,|$)/,h=s||SparkMD5.hash(String(1234567890*Math.random())),c="",l=null,p="",m="",f="";for(u&&d("Strophe.SASLMD5.onChallenge -> called.");t.match(a);)switch(n=t.match(a),t=t.replace(n[0],""),n[2]=n[2].replace(/^"(.+)"$/,"$1"),n[1]){case"realm":c=n[2];break;case"nonce":p=n[2];break;case"qop":m=n[2];break;case"host":l=n[2]}return i=e.servtype+"/"+e.domain,null!==l&&(i=i+"/"+l),r=SparkMD5.hash(e.authcid+":"+c+":"+this._connection.pass)+":"+p+":"+h,o="AUTHENTICATE:"+i,f+="charset=utf-8,",f+="username="+this._quote(e.authcid)+",",f+="realm="+this._quote(c)+",",f+="nonce="+this._quote(p)+",",f+="nc=00000001,",f+="cnonce="+this._quote(h)+",",f+="digest-uri="+this._quote(i)+",",f+="response="+SparkMD5.hash(SparkMD5.hash(r)+":"+p+":00000001:"+h+":auth:"+SparkMD5.hash(o))+",",f+="qop=auth",this.onChallenge=_.bind(function(e,t){return""},this),f},e(r,t,s,n,i)}(function(){"use strict";var e=Array.prototype.slice.call(arguments);window.Strophe=e[0],window.$build=e[1],window.$msg=e[2],window.$iq=e[3],window.$pres=e[4]}),Strophe.addConnectionPlugin("muc",{_connection:null,_p_name:"strophe.plugins.muc - ",init:function(e){"use strict";msos.console.debug(this._p_name+"init -> start."),this._connection=e,Strophe.addNamespace("MUC_OWNER",Strophe.NS.MUC+"#owner"),Strophe.addNamespace("MUC_ADMIN",Strophe.NS.MUC+"#admin"),msos.console.debug(this._p_name+"init -> done!")},join:function(e,t,s,n,i){"use strict";msos.console.debug(this._p_name+"join -> start.");var r,o,a,h,c=this._append_nick(e,t);r=$pres({from:this._connection.jid,to:c}).c("x",{xmlns:Strophe.NS.MUC}),i&&(o=Strophe.xmlElement("password",[],i),r.cnode(o)),s&&(a=this._connection.addStropheHandler(function(t){var n=t.getAttribute("from"),i=n.split("/");return msos.console.debug(this._p_name+"join -> done, msg callback."),i[0]===e?s(t):!0},Strophe.NS.CLIENT,"message"),a.describe="MUC join: "+c),n&&(h=this._connection.addStropheHandler(function(e){var t,s=e.getElementsByTagName("x"),i=0;if(s.length>0)for(i=0;i<s.length;i+=1)if(t=s[i].getAttribute("xmlns"),t&&t.match(Strophe.NS.MUC))return msos.console.debug(this._p_name+"join -> done, pres callback."),n(e);return!0},Strophe.NS.CLIENT,"presence"),h.describe="MUC join: "+c),this._connection.send(r),msos.console.debug(this._p_name+"join -> done!")},leave:function(e,t,s){"use strict";msos.console.debug(this._p_name+"leave -> start.");var n,i=this._append_nick(e,t),r=this._connection.getUniqueId(),o=$pres({type:"unavailable",id:r,from:this._connection.jid,to:i}).c("x",{xmlns:Strophe.NS.MUC});return n=this._connection.addStropheHandler(s,Strophe.NS.CLIENT,"presence",!1,r),this._connection.send(o),msos.console.debug(this._p_name+"leave -> done, room jid: "+i),r},message:function(e,t,s,n){"use strict";msos.console.debug(this._p_name+"message -> start.");var i,r=this._append_nick(e,t),o=this._connection.getUniqueId();return n=n||"groupchat",i=$msg({to:r,from:this._connection.jid,type:n,id:o}).c("body",{xmlns:Strophe.NS.CLIENT}).t(s),i.up().c("x",{xmlns:"jabber:x:event"}).c("composing"),this._connection.send(i),msos.console.debug(this._p_name+"message -> done!"),o},configure:function(e){"use strict";msos.console.debug(this._p_name+"configure -> called.");var t=$iq({to:e,type:"get"}).c("query",{xmlns:Strophe.NS.MUC_OWNER}),s=t.tree();return this._connection.sendIQ(s,"get: query MUC owner")},cancelConfigure:function(e){"use strict";msos.console.debug(this._p_name+"cancelConfigure -> called.");var t=$iq({to:e,type:"set"}).c("query",{xmlns:Strophe.NS.MUC_OWNER}).c("x",{xmlns:"jabber:x:data",type:"cancel"}),s=t.tree();return this._connection.sendIQ(s,"set: query MUC owner, x cancel")},saveConfiguration:function(e,t){"use strict";msos.console.debug(this._p_name+"saveConfiguration -> called.");var s,n=$iq({to:e,type:"set"}).c("query",{xmlns:Strophe.NS.MUC_OWNER}).c("x",{xmlns:"jabber:x:data",type:"submit"}),i=0;for(i=0;i<t.length;i+=1)n.cnode(t[i]),n.up();return s=n.tree(),this._connection.sendIQ(s,"set: query MUC owner, x submit (array up)")},createInstantRoom:function(e){"use strict";msos.console.debug(this._p_name+"createInstantRoom -> called.");var t=$iq({to:e,type:"set"}).c("query",{xmlns:Strophe.NS.MUC_OWNER}).c("x",{xmlns:"jabber:x:data",type:"submit"});return this._connection.sendIQ(t.tree(),"set: query MUC owner, x submit")},setTopic:function(e,t){"use strict";msos.console.debug(this._p_name+"setTopic -> called.");var s=$msg({to:e,from:this._connection.jid,type:"groupchat"}).c("subject",{xmlns:"jabber:client"}).t(t);this._connection.send(s.tree())},modifyUser:function(e,t,s,n,i){"use strict";msos.console.debug(this._p_name+"modifyUser -> called.");var r,o,a={nick:Strophe.escapeNode(t)};return null!==s&&(a.role=s),null!==n&&(a.affiliation=n),r=$build("item",a),null!==i&&r.cnode(Strophe.xmlElement("reason",i)),o=$iq({to:e,type:"set"}).c("query",{xmlns:Strophe.NS.MUC_OWNER}).cnode(r.tree()),this._connection.sendIQ(o.tree(),"set: query MUC owner")},changeNick:function(e,t){"use strict";msos.console.debug(this._p_name+"changeNick -> called.");var s=this._append_nick(e,t),n=$pres({from:this._connection.jid,to:s}).c("x",{xmlns:Strophe.NS.MUC});this._connection.send(n.tree())},listRooms:function(e,t){"use strict";msos.console.debug(this._p_name+"listRooms -> called.");var s=$iq({to:e,from:this._connection.jid,type:"get"}).c("query",{xmlns:Strophe.NS.DISCO_ITEMS});this._connection.sendIQ(s,"get: query disco items (MUC)",t)},_append_nick:function(e,t){"use strict";var s=e;return t&&(s+="/"+Strophe.escapeNode(t)),msos.console.debug(this._p_name+"_append_nick -> called, room jid: "+s),s}}),Strophe.addConnectionPlugin("disco",{_connection:null,_identities:[],_features:[],_items:[],_p_name:"strophe.plugins.disco - ",init:function(e){"use strict";msos.console.debug(this._p_name+"init -> start."),this._connection=e,this._identities=[],this._features=[],this._items=[],msos.console.debug(this._p_name+"init -> done!")},statusChanged:function(e){"use strict";return e===Strophe.Status.CONNECTED?(this._connection.addStropheHandler(_.bind(this._onDiscoInfo,this),Strophe.NS.DISCO_INFO,"iq","get"),this._connection.addStropheHandler(_.bind(this._onDiscoItems,this),Strophe.NS.DISCO_ITEMS,"iq","get"),!0):!1},addIdentity:function(e,t,s,n){"use strict";var i=0;for(i=0;i<this._identities.length;i+=1)if(this._identities[i].category===e&&this._identities[i].type===t&&this._identities[i].name===s&&this._identities[i].lang===n)return!1;return this._identities.push({category:e,type:t,name:s,lang:n}),!0},addFeature:function(e){"use strict";var t=0;for(t=0;t<this._features.length;t+=1)if(this._features[t]===e)return!1;return this._features.push(e),!0},removeFeature:function(e){"use strict";var t=0;for(t=0;t<this._features.length;t+=1)if(this._features[t]===e)return this._features.splice(t,1),!0;return!1},addItem:function(e,t,s,n){"use strict";return s&&!n?!1:(this._items.push({jid:e,name:t,node:s,call_back:n}),!0)},info:function(e,t,s,n,i){"use strict";var r,o={xmlns:Strophe.NS.DISCO_INFO};t&&(o.node=t),r=$iq({from:this._connection.jid,to:e,type:"get"}).c("query",o),this._connection.sendIQ(r,"get: query disco info",s,n,i)},items:function(e,t,s,n,i){"use strict";var r,o={xmlns:Strophe.NS.DISCO_ITEMS};t&&(o.node=t),r=$iq({from:this._connection.jid,to:e,type:"get"}).c("query",o),this._connection.sendIQ(r,"get: query disco items",s,n,i)},_buildIQResult:function(e,t){"use strict";var s=e.getAttribute("id"),n=e.getAttribute("from"),i=$iq({type:"result",id:s});return null!==n&&i.attrs({to:n}),i.c("query",t)},_onDiscoInfo:function(e){"use strict";var t,s,n=e.getElementsByTagName("query")[0].getAttribute("node"),i={xmlns:Strophe.NS.DISCO_INFO};for(n&&(i.node=n),s=this._buildIQResult(e,i),t=0;t<this._identities.length;t+=1)i={category:this._identities[t].category,type:this._identities[t].type},this._identities[t].name&&(i.name=this._identities[t].name),this._identities[t].lang&&(i["xml:lang"]=this._identities[t].lang),s.c("identity",i).up();for(t=0;t<this._features.length;t+=1)s.c("feature",{"var":this._features[t]}).up();return this._connection.send(s.tree()),!0},_onDiscoItems:function(e){"use strict";var t,s,n,i,r={xmlns:Strophe.NS.DISCO_ITEMS},o=e.getElementsByTagName("query")[0].getAttribute("node");if(o){for(r.node=o,t=[],s=0;s<this._items.length;s+=1)if(this._items[s].node===o){t=this._items[s].call_back(e);break}}else t=this._items;for(n=this._buildIQResult(e,r),s=0;s<t.length;s+=1)i={jid:t[s].jid},t[s].name&&(i.name=t[s].name),t[s].node&&(i.node=t[s].node),n.c("item",i).up();return this._connection.send(n.tree()),!0}}),Strophe.addConnectionPlugin("caps",{HASH:"sha-1",node:"http://strophe.im/strophejs/",_ver:"",_connection:null,_knownCapabilities:{},_jidVerIndex:{},_p_name:"strophe.plugins.caps - ",init:function(e){"use strict";if(msos.console.debug(this._p_name+"init -> start."),this._connection=e,Strophe.addNamespace("CAPS","http://jabber.org/protocol/caps"),!this._connection.disco)throw"Caps plugin requires the disco plugin to be installed.";this._connection.disco.addFeature(Strophe.NS.CAPS),this._connection.disco.addFeature(Strophe.NS.DISCO_INFO),this._connection.disco.addFeature(Strophe.NS.RECEIPTS),msos.console.debug(this._p_name+"init -> done!")},statusChanged:function(e){"use strict";return e===Strophe.Status.CONNECTING?(this._connection.addStropheHandler(_.bind(this._delegateCapabilities,this),Strophe.NS.CAPS,"presence"),!0):!1},generateCapsAttrs:function(){"use strict";return{xmlns:Strophe.NS.CAPS,hash:this.HASH,node:this.node,ver:this.generateVer()}},generateVer:function(){"use strict";function e(e,t){var s=(65535&e)+(65535&t),n=(e>>16)+(t>>16)+(s>>16);return n<<16|65535&s}function t(e){var t=[],s=255,n=0;for(n=0;n<8*e.length;n+=8)t[n>>5]|=(e.charCodeAt(n/8)&s)<<24-n%32;return t}function s(e,t){return e<<t|e>>>32-t}function n(e,t,s,n){return 20>e?t&s|~t&n:40>e?t^s^n:60>e?t&s|t&n|s&n:t^s^n}function i(e){return 20>e?1518500249:40>e?1859775393:60>e?-1894007588:-899497514}function r(t,r){t[r>>5]|=128<<24-r%32,t[(r+64>>9<<4)+15]=r;var o,a,h,c,u,d,l,_,p=new Array(80),m=1732584193,f=-271733879,g=-1732584194,b=271733878,S=-1009589776;for(o=0;o<t.length;o+=16){for(c=m,u=f,d=g,l=b,_=S,a=0;80>a;a+=1)p[a]=16>a?t[o+a]:s(p[a-3]^p[a-8]^p[a-14]^p[a-16],1),h=e(e(s(m,5),n(a,f,g,b)),e(e(S,p[a]),i(a))),S=b,b=g,g=s(f,30),f=m,m=h;m=e(m,c),f=e(f,u),g=e(g,d),b=e(b,l),S=e(S,_)}return[m,f,g,b,S]}function o(e){var t,s,n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",i="",r=0;for(r=0;r<4*e.length;r+=3)for(t=(e[r>>2]>>8*(3-r%4)&255)<<16|(e[r+1>>2]>>8*(3-(r+1)%4)&255)<<8|e[r+2>>2]>>8*(3-(r+2)%4)&255,s=0;4>s;s+=1)i+=8*r+6*s>32*e.length?"=":n.charAt(t>>6*(3-s)&63);return i}function a(e){return o(r(t(e),8*e.length))}if(""!==this._ver)return this._ver;var h,c=0,u="",d=this._connection.disco._identities.sort(this._sortIdentities),l=d.length,_=this._connection.disco._features.sort(),p=_.length;for(c=0;l>c;c+=1)h=d[c],u+=h.category+"/"+h.type+"/"+h.lang+"/"+h.name+"<";for(c=0;p>c;c+=1)u+=_[c]+"<";return this._ver=a(u),this._ver},getCapabilitiesByJid:function(e){"use strict";return this._jidVerIndex[e]?this._knownCapabilities[this._jidVerIndex[e]]:null},_delegateCapabilities:function(e){"use strict";var t=e.getAttribute("from"),s=e.querySelector("c"),n=s.getAttribute("ver"),i=s.getAttribute("node");return this._knownCapabilities[n]?(this._jidVerIndex[t]=n,this._jidVerIndex[t]&&!this._jidVerIndex[t]===n||(this._jidVerIndex[t]=n),!0):this._requestCapabilities(t,i,n)},_requestCapabilities:function(e,t,s){"use strict";var n;return e!==this._connection.jid&&(n=this._connection.disco.info(e,t+"#"+s),this._connection.addStropheHandler(_.bind(this._handleDiscoInfoReply,this),Strophe.NS.DISCO_INFO,"iq","result",n,e)),!0},_handleDiscoInfoReply:function(e){"use strict";var t,s,n,i=e.querySelector("query"),r=i.getAttribute("node").split("#"),o=r[1],a=e.getAttribute("from"),h=0;if(this._knownCapabilities[o])this._jidVerIndex[a]&&!this._jidVerIndex[a]===o||(this._jidVerIndex[a]=o);else{for(t=i.childNodes,s=t.length,this._knownCapabilities[o]=[],h=0;s>h;h+=1)n=t[h],this._knownCapabilities[o].push({name:n.nodeName,attributes:n.attributes});this._jidVerIndex[a]=o}return!1},_sortIdentities:function(e,t){"use strict";return e.category>t.category?1:e.category<t.category?-1:e.type>t.type?1:e.type<t.type?-1:e.lang>t.lang?1:e.lang<t.lang?-1:0}}),Strophe.addConnectionPlugin("roster",{_p_name:"strophe.plugins.roster - ",init:function(e){msos.console.debug(this._p_name+"init -> start."),this._connection=e,this._callbacks=[],this._callbacks_request=[],this.items=[],ver=null;var t,s;roster=this,_connect=e.connect,_attach=e.attach,s=function(s){var n,i;(s==Strophe.Status.ATTACHED||s==Strophe.Status.CONNECTED)&&(n=e.addStropheHandler(_.bind(roster._onReceivePresence,roster),Strophe.NS.CLIENT,"presence"),i=e.addStropheHandler(_.bind(roster._onReceiveIQ,roster),Strophe.NS.ROSTER,"iq","set"),n.describe="subscribe, unavailable: roster",i.describe="set: roster"),null!==t&&t.apply(this,arguments)},e.connect=function(n,i,r,o,a,h){t=r,"undefined"==typeof n&&(n=null),"undefined"==typeof i&&(i=null),r=s,_connect.apply(e,[n,i,r,o,a,h])},e.attach=function(n,i,r,o,a,h,c){t=o,"undefined"==typeof n&&(n=null),"undefined"==typeof i&&(i=null),"undefined"==typeof r&&(r=null),o=s,_attach.apply(e,[n,i,r,o,a,h,c])},Strophe.addNamespace("ROSTER_VER","urn:xmpp:features:rosterver"),Strophe.addNamespace("NICK","http://jabber.org/protocol/nick"),msos.console.debug(this._p_name+"init -> done!")},supportVersioning:function(){return this._connection.features&&this._connection.features.getElementsByTagName("ver").length>0},get:function(e,t,s){var n,i={xmlns:Strophe.NS.ROSTER};return msos.console.debug(this._p_name+"get -> called."),this.items=[],this.supportVersioning()&&(i.ver=t||"",this.items=s||[]),n=$iq({type:"get",id:this._connection.getUniqueId("roster")}).c("query",i),this._connection.sendIQ(n,"get: query roster",this._onReceiveRosterSuccess.bind(this,e),this._onReceiveRosterError.bind(this,e),!1,Strophe.NS.ROSTER)},registerCallback:function(e){msos.console.debug(this._p_name+"registerCallback -> called."),this._callbacks.push(e)},registerRequestCallback:function(e){msos.console.debug(this._p_name+"registerRequestCallback -> called."),this._callbacks_request.push(e)},findItem:function(e){var t=0;for(msos.console.debug(this._p_name+"findItem -> called, jid: "+e),t=0;t<this.items.length;t+=1)if(this.items[t]&&this.items[t].jid==e)return this.items[t];return!1},removeItem:function(e){var t=0;for(msos.console.debug(this._p_name+"removeItem -> called, jid: "+e),t=0;t<this.items.length;t+=1)if(this.items[t]&&this.items[t].jid==e)return this.items.splice(t,1),!0;return!1},subscribe:function(e,t,s){var n=$pres({to:e,type:"subscribe"});t&&""!==t&&n.c("status").t(t).up(),s&&""!==s&&n.c("nick",{xmlns:Strophe.NS.NICK}).t(s).up(),this._connection.send(n)},unsubscribe:function(e,t){var s=$pres({to:e,type:"unsubscribe"});t&&""!==t&&s.c("status").t(t),this._connection.send(s)},authorize:function(e,t){var s=$pres({to:e,type:"subscribed"});t&&""!==t&&s.c("status").t(t),this._connection.send(s)},unauthorize:function(e,t){var s=$pres({to:e,type:"unsubscribed"});t&&""!==t&&s.c("status").t(t),this._connection.send(s)},add:function(e,t,s,n){var i=$iq({type:"set"}).c("query",{xmlns:Strophe.NS.ROSTER}).c("item",{jid:e,name:t}),r=0;for(r=0;r<s.length;r+=1)i.c("group").t(s[r]).up();this._connection.sendIQ(i,"set: query roster, item jid/name",n,n,!1,Strophe.NS.ROSTER)},update:function(e,t,s,n){var i,r,o,a=this.findItem(e),h=0;if(!a)throw"item not found";for(i=t||a.name,r=s||a.groups,o=$iq({type:"set"}).c("query",{xmlns:Strophe.NS.ROSTER}).c("item",{jid:a.jid,name:i}),h=0;h<r.length;h+=1)o.c("group").t(r[h]).up();return this._connection.sendIQ(o,"set: query roster, item jid/name",n,n,!1,Strophe.NS.ROSTER)},remove:function(e,t){var s,n=this.findItem(e);if(!n)throw"item not found";s=$iq({type:"set"}).c("query",{xmlns:Strophe.NS.ROSTER}).c("item",{jid:n.jid,subscription:"remove"}),this._connection.sendIQ(s,"set: query roster, item remove",t,t,!1,Strophe.NS.ROSTER)},_onReceiveRosterSuccess:function(e,t){this._updateItems(t),e(this.items)},_onReceiveRosterError:function(e,t){e(this.items)},_onReceivePresence:function(e){var t=e.getAttribute("from"),s=Strophe.getBareJidFromJid(t),n=this.findItem(s),i=e.getAttribute("type");if(!n)return"subscribe"===i&&this._call_backs_request(s),!0;if("unavailable"==i)delete n.resources[Strophe.getResourceFromJid(t)];else{if(i)return!0;n.resources[Strophe.getResourceFromJid(t)]={show:0!==e.getElementsByTagName("show").length?Strophe.getText(e.getElementsByTagName("show")[0]):"",status:0!==e.getElementsByTagName("status").length?Strophe.getText(e.getElementsByTagName("status")[0]):"",priority:0!==e.getElementsByTagName("priority").length?Strophe.getText(e.getElementsByTagName("priority")[0]):""}}return this._call_backs(this.items,n),!0},_call_backs_request:function(e){var t=0;for(t=0;t<this._callbacks_request.length;t+=1)this._callbacks_request[t](e)},_call_backs:function(e,t){var s=0;for(s=0;s<this._callbacks.length;s+=1)this._callbacks[s](e,t)},_onReceiveIQ:function(e){var t,s=e.getAttribute("id"),n=e.getAttribute("from");if(n&&""!==n&&n!=this._connection.jid&&n!=Strophe.getBareJidFromJid(this._connection.jid))return!0;

var t=$iq({type:"result",id:s,from:this._connection.jid});return this._connection.send(t),this._updateItems(e),!0},_updateItems:function(e){var t=e.getElementsByTagName("query"),s=this;0!==t.length&&(this.ver=t.item(0).getAttribute("ver"),jQuery(t.item(0)).children("item").each(function(e,t){s._updateItem(t)})),this._call_backs(this.items)},_updateItem:function(e){var t=e.getAttribute("jid"),s=e.getAttribute("name"),n=e.getAttribute("subscription"),i=e.getAttribute("ask"),r=[];return jQuery(e).children("group").each(function(e,t){r.push(Strophe.getText(t))}),"remove"==n?void this.removeItem(t):(e=this.findItem(t),void(e?(e.name=s,e.subscription=n,e.ask=i,e.groups=r):this.items.push({name:s,jid:t,subscription:n,ask:i,groups:r,resources:{}})))}});